#include <stdio.h>
#include <string.h>
#include <stdlib.h>

// Commands
#define HELP "help"
#define FLAG "flag"
#define UPCASE "upcase"
#define QUIT "quit"

#define on_str_equal(s1,s2) if (strcmp (s1,s2) == 0)
#define on_quit(cmd, callback) on_str_equal(cmd, QUIT) { callback; break; }
#define on_flag(cmd, callback) on_str_equal(cmd, FLAG) { callback; continue; }
#define on_upcase(cmd, callback) on_str_equal(cmd, UPCASE) { callback; continue; }
#define on_help(cmd, callback) on_str_equal(cmd, HELP) { callback; continue; }

#define LINELEN (41*2+1)
#define LINE for (i = 0; i < 41; i++) printf ("-="); printf ("-\n");
#define PROMPT printf (">>> ")

#define HELP_STRING \
  "Los comandos disponibles son:\n" \
  "  - help\n"                      \
  "  - quit\n"                      \
  "  - flag\n"                      \
  "  - upcase"

void banner(void);
void loop(void);
void help(void);
void flag(void);
void upcase(void);
void setup(void);

char *flag_var;

int main(int argc, char **argv) {
  setup ();
  banner ();
  loop ();

  free (flag_var);

  return 0;
}

#define FLAG_VAR "flag{9e0480fa680754a7286b9686ce606f22}"

void setup(void) {
  flag_var = (char*)calloc ((strlen (FLAG_VAR) + 1), sizeof (char));

  strcpy (flag_var, FLAG_VAR);
}

#define print_centered(s, size) \
  printf ("%*s\n", size / 2 + strlen (s) / 2, s, size / 2 - strlen (s) / 2, "")

void banner(void) {
  int i;
  LINE;
  print_centered("Pepito Perez Rodriguez", LINELEN);
  print_centered("Fundamentos de la programación", LINELEN);
  LINE;
  puts ("Este programa recibe una cadena por entrada y la devuelve toda en mayúsculas.\n"
        "Funciona genial, pero aun así me han suspendido. No entiendo por qué no puedo poner\n"
        "variables globales. Así puedo acceder a los datos desde cualquier lado.\n"
        "¿A que mola? ¿Verdad? ¡¿Verdad?! No entiendo por qué me han suspendido...");
  LINE;
}

void loop(void) {
  char command[32];

  while (1) {
    puts ("\nIntroduce comandos. Usa 'help' para ver la ayuda.");
    PROMPT;
    fflush (stdout);
    fgets (command, 30, stdin);
    command[strlen (command) - 1] = '\0';

    on_quit (command, {
      puts ("Bye bye!");
    });

    on_flag (command, {
      flag ();
    });

    on_upcase (command, {
      upcase ();
    });

    on_help (command, {
      help ();
    });

    puts ("No se que significa eso.");
  }
}

void flag(void) {
  printf ("La flag parece ser que esta en 0x%08x\n", flag_var);
}

void upcase(void) {
  char str[512];
  char *upcase_str;
  int i;

  puts ("Introduce la cadena que va a ser convertida (max 500 caracteres):");
  PROMPT;
  fflush (stdout);
  fgets (str, 500, stdin);
  str[strlen (str) - 1] = '\0';

  printf ("Has introducido: ");
  printf (str);
  puts ("");

  upcase_str = (char *)calloc (strlen (str) + 1, sizeof (char));

  strncpy (upcase_str, str, strlen (str));

  for (i = 0; i < strlen (upcase_str); i++) {
    upcase_str[i] = toupper (upcase_str[i]);
  }

  printf ("El resultado:    %s\n", upcase_str);

  free (upcase_str);
}

void help(void) {
  puts (HELP_STRING);
}
